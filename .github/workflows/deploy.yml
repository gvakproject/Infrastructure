name: Deploy SteamInfrastructure to EC2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      skip_sql_init:
        description: 'Skip SQL database initialization'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Display deployment parameters
      run: |
        echo "üöÄ Starting deployment to: ${{ inputs.environment }}"
        echo "üìä Skip SQL initialization: ${{ inputs.skip_sql_init }}"
        echo "‚è∞ Deployment started at: $(date)"
      
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create deployment directories on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
          mkdir -p /home/${{ secrets.USERNAME }}/SteamInfrastructure
          mkdir -p /home/${{ secrets.USERNAME }}/SteamInfrastructure/data/sqlserver
          mkdir -p /home/${{ secrets.USERNAME }}/SteamInfrastructure/scrapoxy
          mkdir -p /home/${{ secrets.USERNAME }}/SteamInfrastructure/sql
          mkdir -p /home/${{ secrets.USERNAME }}/SteamInfrastructure/scripts
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
          chmod 755 /home/${{ secrets.USERNAME }}/SteamInfrastructure
          chmod 755 /home/${{ secrets.USERNAME }}/SteamInfrastructure/data
          chmod 755 /home/${{ secrets.USERNAME }}/SteamInfrastructure/data/sqlserver
          chmod 755 /home/${{ secrets.USERNAME }}/SteamInfrastructure/scrapoxy
          chmod 755 /home/${{ secrets.USERNAME }}/SteamInfrastructure/sql
          chmod 755 /home/${{ secrets.USERNAME }}/SteamInfrastructure/scripts
          
          echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          
    - name: Copy project files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "."
        target: "/home/${{ secrets.USERNAME }}/SteamInfrastructure"
        strip_components: 0
        
    - name: Set executable permissions for scripts
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.USERNAME }}/SteamInfrastructure
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
          ls -la
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–∫–∏ sql:"
          ls -la sql/
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ init.sql:"
          ls -la sql/init.sql
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
          chmod +x scripts/*.sh
          echo "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
    - name: Stop existing containers
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.USERNAME }}/SteamInfrastructure
          
          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          docker stop steam-sqlserver steam-scrapoxy 2>/dev/null || true
          docker rm steam-sqlserver steam-scrapoxy 2>/dev/null || true
          
          echo "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          
    - name: Start SQL Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.USERNAME }}/SteamInfrastructure
          
          # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è SQL Server
          sudo chown -R 10001:0 data/sqlserver
          sudo chmod -R 777 data/sqlserver
          
          # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ SQL Server —Å volume mapping
          docker run -d --name steam-sqlserver \
            -p 1433:1433 \
            -e ACCEPT_EULA=Y \
            -e SA_PASSWORD="${{ secrets.SQL_SERVER_PASSWORD }}" \
            -e MSSQL_PID=Express \
            -e MSSQL_COLLATION=SQL_Latin1_General_CP1_CI_AS \
            -v "$(pwd)/data/sqlserver:/var/opt/mssql" \
            --user 10001:0 \
            --restart unless-stopped \
            mcr.microsoft.com/mssql/server:2022-latest
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞
          sleep 10
          if ! docker ps | grep -q steam-sqlserver; then
            echo "–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º –±–µ–∑ volume mapping..."
            docker rm steam-sqlserver 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫ –±–µ–∑ volume mapping (–¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
            docker run -d --name steam-sqlserver \
              -p 1433:1433 \
              -e ACCEPT_EULA=Y \
              -e SA_PASSWORD="${{ secrets.SQL_SERVER_PASSWORD }}" \
              -e MSSQL_PID=Express \
              -e MSSQL_COLLATION=SQL_Latin1_General_CP1_CI_AS \
              --restart unless-stopped \
              mcr.microsoft.com/mssql/server:2022-latest
          fi
            
          if [ $? -eq 0 ]; then
            echo "SQL Server –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          else
            echo "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å SQL Server!"
            exit 1
          fi
          
    - name: Wait for SQL Server to be ready
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SQL Server (30 —Å–µ–∫—É–Ω–¥)..."
          sleep 30
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SQL Server
          max_attempts=10
          attempt=0
          sql_ready=false
          
          while [ $attempt -lt $max_attempts ] && [ "$sql_ready" = false ]; do
            if docker exec steam-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U "sa" -P "${{ secrets.SQL_SERVER_PASSWORD }}" -N -C -Q "SELECT 1" >/dev/null 2>&1; then
              sql_ready=true
              echo "SQL Server –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
            else
              attempt=$((attempt + 1))
              echo "–ü–æ–ø—ã—Ç–∫–∞ $attempt/$max_attempts - –æ–∂–∏–¥–∞–Ω–∏–µ..."
              sleep 5
            fi
          done
          
          if [ "$sql_ready" = false ]; then
            echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: SQL Server –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
          fi
          
    - name: Initialize SQL Server database
      if: ${{ !inputs.skip_sql_init }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.USERNAME }}/SteamInfrastructure
          
          echo "üóÑÔ∏è Initializing SQL Server database..."
          
          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL —Å–∫—Ä–∏–ø—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
          if [ -f "sql/init.sql" ]; then
            echo "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ SQL Server (30 —Å–µ–∫—É–Ω–¥)..."
            sleep 30
            
            echo "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL —Å–∫—Ä–∏–ø—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
            docker exec -i steam-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U "sa" -P "${{ secrets.SQL_SERVER_PASSWORD }}" -N -C < "sql/init.sql"
            if [ $? -eq 0 ]; then
              echo "SQL —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
              
              # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è)
              echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
              docker exec steam-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U "sa" -P "${{ secrets.SQL_SERVER_PASSWORD }}" -N -Q "SELECT name FROM sys.databases WHERE name = 'SteamInfrastructure'" 2>/dev/null || echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–ø—É—â–µ–Ω–∞ (SSL –æ—à–∏–±–∫–∞)"
              
              # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è)
              echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:"
              docker exec steam-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U "sa" -P "${{ secrets.SQL_SERVER_PASSWORD }}" -N -Q "USE SteamInfrastructure; SELECT name FROM sys.tables" 2>/dev/null || echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü –ø—Ä–æ–ø—É—â–µ–Ω–∞ (SSL –æ—à–∏–±–∫–∞)"
            else
              echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SQL —Å–∫—Ä–∏–ø—Ç–∞, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±..."
              
              # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ bash
              docker exec steam-sqlserver bash -c "cat /var/opt/mssql/data/init.sql 2>/dev/null || echo 'CREATE DATABASE SteamInfrastructure;' | /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P '${{ secrets.SQL_SERVER_PASSWORD }}' -N -C"
              
              # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º
              docker cp sql/init.sql steam-sqlserver:/tmp/init.sql
              docker exec steam-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U "sa" -P "${{ secrets.SQL_SERVER_PASSWORD }}" -N -C -i /tmp/init.sql
              
              if [ $? -eq 0 ]; then
                echo "SQL —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º"
              else
                echo "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç"
              fi
            fi
          else
            echo "–û–®–ò–ë–ö–ê: SQL —Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ sql:"
            ls -la sql/
            exit 1
          fi
          
    - name: Start Scrapoxy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.USERNAME }}/SteamInfrastructure
          
          # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Scrapoxy
          cat > scrapoxy/config.json << EOF
          {
            "name": "steam-scrapoxy",
            "version": "1.0.0",
            "proxies": [],
            "sessions": []
          }
          EOF
          
          # –ó–∞–ø—É—Å–∫ Scrapoxy (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ —Ä–∞–±–æ—á–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é)
          docker run -d --name steam-scrapoxy \
            -p 8889:8888 -p 8891:8890 \
            -e AUTH_LOCAL_USERNAME="${{ secrets.SCRAPOXY_USERNAME }}" \
            -e AUTH_LOCAL_PASSWORD="${{ secrets.SCRAPOXY_PASSWORD }}" \
            -e BACKEND_JWT_SECRET="${{ secrets.SCRAPOXY_BACKEND_SECRET }}" \
            -e FRONTEND_JWT_SECRET="${{ secrets.SCRAPOXY_FRONTEND_SECRET }}" \
            -e STORAGE_FILE_FILENAME=/etc/scrapoxy/config.json \
            -v "$(pwd)/scrapoxy:/etc/scrapoxy" \
            --restart unless-stopped \
            scrapoxy/scrapoxy:latest
            
          if [ $? -eq 0 ]; then
            echo "Scrapoxy –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          else
            echo "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Scrapoxy!"
            exit 1
          fi
          
    - name: Wait for Scrapoxy to be ready
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Scrapoxy (10 —Å–µ–∫—É–Ω–¥)..."
          sleep 10
          
    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è SteamInfrastructure ==="
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          echo "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
          docker ps --filter "name=steam-"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:"
          netstat -tlnp | grep -E ":(1433|8889|8891)" || echo "–ü–æ—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ netstat"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ SQL Server (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è)
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ SQL Server:"
          if docker exec steam-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U "sa" -P "${{ secrets.SQL_SERVER_PASSWORD }}" -N -Q "SELECT @@VERSION" >/dev/null 2>&1; then
            echo "‚úì SQL Server –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö† SQL Server –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ (SSL –æ—à–∏–±–∫–∞, –Ω–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç)"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Scrapoxy
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Scrapoxy:"
          if curl -s http://localhost:8889/api/health >/dev/null 2>&1; then
            echo "‚úì Scrapoxy API –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚úó Scrapoxy API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          if curl -s http://localhost:8891 >/dev/null 2>&1; then
            echo "‚úì Scrapoxy Web UI –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚úó Scrapoxy Web UI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          echo ""
          echo "=== SteamInfrastructure —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç! ==="
          echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
          echo "  - SQL Server: ${{ secrets.HOST }}:1433"
          echo "  - Scrapoxy API: http://${{ secrets.HOST }}:8889"
          echo "  - Scrapoxy Web UI: http://${{ secrets.HOST }}:8891"
          echo ""
          echo "–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ –ø–∞–ø–∫–µ scripts/"
